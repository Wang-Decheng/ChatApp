# 网络实验八实验报告

| 组号 |
| ---- |
|      |

| 姓名   | 学号       | 班级       |
| ------ | ---------- | ---------- |
| 王德成 | 2203712695 | 计算机2104 |

## 一、实验名称

	1. Socket网络编程，实现一个简单的聊天程序
	1. 

## 二、实验原理

### 1.聊天程序

​	客户端将请求信息与数据通过一定形式的组织后通过Socket发送给服务器，服务器对信息进行处理后将响应数据通过一定形式的组织后再将数据通过socket发送回客户端，客户端处理响应并针对性的执行一些操作

### 2.GBN、SR

## 三、实验目的

1. 掌握Sockets的相关基础知识，学习Sockets编程的基本函数和模式、框架。
2. 掌握 UDP、TCP 协议及 Client/Server 和 P2P 两种模式的通信原理。掌握
   可靠数据传输协议（GBN 和 SR 协议）
3. 掌握 socket 编程框架

## 四、实验内容

### 1.聊天程序

​	基础功能包括验证用户注册和用户登录，用户间的文字聊天，用户间的文件传输。高级功能包括添加和删除好友，传输离线文件和发送离线消息，使用数据库对用户信息进行管理，并使用`PyQt`开发了图形界面

### 2.GBN

## 五、实验实现

### 1.人员分工

​	王德成：负责聊天程序前期框架的搭建，主要负责服务器端程序的编写以及相关部分的实验报告的撰写

​	唐晨航：

​	杨泽晟：

### 2.实验设计

#### （一）协议

##### 网络聊天程序

​	网络聊天程序依赖于TCP协议，采用CSC模式工作。我们采用了编写一个类`MessageBuilder`来构造生成服务器端和客户端通信的消息实例，消息均为字典对象，由于消息类型的不同，其携带的数据信息也不同，通过`type`与`action`等字段标明消息的类型以便接收方解析。在消息对象生成过后，将其转化为`json`字节流并通过TCP协议发送。由于TCP是流式协议，会将时间间隔短的数据一次性打包发送，导致可能多条不同的消息被同时接受从而出现消息解析错误。为解决这一问题，我们在发送消息的时候，为每个消息的末尾添加了分隔符`!@#`，并适当的加大了消息接受的缓冲区的大小，从而保证了绝大多数情况下不会出现这样的问题。

##### GBN程序

#### （二）UI设计

##### 网络聊天程序

​	网络聊天程序的客户端通过`PyQt`框架为用户提供了基本的可视化界面，提供了注册、登录、删除账户，添加、删除好友，聊天以及发送文件的界面以及按钮。

##### GBN程序

#### （三）框架结构

##### 网络聊天程序

###### 服务器端

​	服务器端通过`MessageServer`类来监听来自客户端的连接和消息，并通过这个类将处理好的消息和响应发回给客户端。`MessageServer`也负责解析来自客户端的消息，并调用相应的函数交由对应的类处理来自客户端的消息。同时在该类中实现了心跳包的机制用来判断用户的连接状态和在线状态。

​	类`MeaasgeHandler`负责接受由`MeaasgeServer`解析过后的消息，并根据消息的类型（主要是请求消息）调用类中对应的函数进行处理，之后通过`MessageBuilder`构造响应消息，交由`MessageServer`将响应发送回客户端。

​	类`UserManager`负责用户的信息和状态管理，通过数`Sqlite`数据库持久化存储和管理用户的信息，提供用户注册、登录、登出、注销，添加好友、删除好友、获取好友列表等功能。

​	类`FileTransferServer`负责监听来自客户端的连接，并根据传入的参数，向客户端发送文件或者接受来自客户端的文件。

​	类`Manager`实现了一个单例模式，并在初始化的时候实例化各个相关的类，方便不同模块之间的相互调用。

​	类`Config`负责从`config.ini`文件中读取相关的配置信息并保存为自己的成员，方便其他模块方便地获取相关参数。

###### 工具类

`MessageBuilder`已在前面协议部分描述过，故不赘述。`Utils`类主要提供了对用户名和密码的合法性校验以及对密码的哈希加密功能

###### 客户端

##### GBN程序

### 3.聊天程序关键代码描述

#### 用户注册、登录和注销

##### 注册

​	用户在GUI中输入注册的用户名和密码，点击注册按钮，客户端向服务器端发送注册用户请求。服务器端接收到请求后，通过用户管理模块进行注册用户操作，注册时，会首先验证请求的用户名和密码信息是否是符合一定的规范，比如长度要求等，然后会检查该用户名是否已经存在，若不存在，则在表中新建一条用户名和密码的关系，其中密码使用hash加密存储

##### 登录

​	用户在GUI中输入要登录的用户名和密码，点击登录按钮，客户端向服务器端发送登录用户请求。服务器端收到请求后，