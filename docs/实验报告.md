# 网络实验八实验报告

| 组号 |
| ---- |
| 2-7  |

| 姓名   | 学号       | 班级       |
| ------ | ---------- | ---------- |
| 王德成 | 2203712695 | 计算机2104 |
| 唐晨航 | 2204112332 | 计算机2104 |
| 杨泽晟 |            |            |

## 一、实验名称

    1. Socket网络编程，实现一个简单的聊天程序
    2.

## 二、实验原理

### 1.聊天程序

    客户端将请求信息与数据通过一定形式的组织后通过Socket发送给服务器，服务器对信息进行处理后将响应数据通过一定形式的组织后再将数据通过socket发送回客户端，客户端处理响应并针对性的执行一些操作

### 2.GBN、SR

## 三、实验目的

1. 掌握Sockets的相关基础知识，学习Sockets编程的基本函数和模式、框架。
2. 掌握 UDP、TCP 协议及 Client/Server 和 P2P 两种模式的通信原理。掌握
   可靠数据传输协议（GBN 和 SR 协议）
3. 掌握 socket 编程框架

## 四、实验内容

### 1.聊天程序

    基础功能包括验证用户注册和用户登录，用户间的文字聊天，用户间的文件传输。高级功能包括添加和删除好友，传输离线文件和发送离线消息，使用数据库对用户信息进行管理，并使用`PyQt`开发了图形界面

### 2.GBN

## 五、实验实现

### 1.人员分工

    王德成：负责聊天程序前期框架的搭建，主要负责服务器端程序的编写

    唐晨航：负责聊天程序客户端的编写，以及聊天软件的测试和自测报告编写

    杨泽晟：负责GBN-SR文件传输协议的设计，以及未完成的node.js客户端的编写

### 2.实验设计

#### （一）协议

##### 网络聊天程序

    网络聊天程序依赖于TCP协议，采用CSC模式工作。我们采用了编写一个类`MessageBuilder`来构造生成服务器端和客户端通信的消息实例，消息均为字典对象，由于消息类型的不同，其携带的数据信息也不同，通过 `type`与 `action`等字段标明消息的类型以便接收方解析。在消息对象生成过后，将其转化为 `json`字节流并通过TCP协议发送。由于TCP是流式协议，会将时间间隔短的数据一次性打包发送，导致可能多条不同的消息被同时接受从而出现消息解析错误。为解决这一问题，我们在发送消息的时候，为每个消息的末尾添加了分隔符 `!@#`，并适当的加大了消息接受的缓冲区的大小，从而保证了绝大多数情况下不会出现这样的问题。

##### GBN程序

#### （二）UI设计

##### 网络聊天程序

    网络聊天程序的客户端通过`PyQt`框架为用户提供了基本的可视化界面，包括注册账号、登录已有账号、删除账户，添加、删除好友，聊天以及发送文件的界面以及按钮。

##### GBN程序

#### （三）框架结构

##### 网络聊天程序

###### 服务器端

    服务器端通过`MessageServer`类来监听来自客户端的连接和消息，并通过这个类将处理好的消息和响应发回给客户端。`MessageServer`也负责解析来自客户端的消息，并调用相应的函数交由对应的类处理来自客户端的消息。同时在该类中实现了心跳包的机制用来判断用户的连接状态和在线状态。

    类`MeaasgeHandler`负责接受由 `MeaasgeServer`解析过后的消息，并根据消息的类型（主要是请求消息）调用类中对应的函数进行处理，之后通过 `MessageBuilder`构造响应消息，交由 `MessageServer`将响应发送回客户端。

    类`UserManager`负责用户的信息和状态管理，通过数 `Sqlite`数据库持久化存储和管理用户的信息，提供用户注册、登录、登出、注销，添加好友、删除好友、获取好友列表等功能。

    类`FileTransferServer`负责监听来自客户端的连接，并根据传入的参数，向客户端发送文件或者接受来自客户端的文件。

    类`Manager`实现了一个单例模式，并在初始化的时候实例化各个相关的类，方便不同模块之间的相互调用。

    类`Config`负责从 `config.ini`文件中读取相关的配置信息并保存为自己的成员，方便其他模块方便地获取相关参数。

###### 工具类

    `MessageBuilder`类已在前面协议部分描述过，故不赘述。

    `Utils`类主要提供了对用户名和密码的合法性校验以及对密码的哈希加密功能

###### 客户端

    `CurrentUser`类主要用来记录当前登录用户，当前用户切换时，该类的实例同时切换为不同的用户

    `ChatConnection`类主要用来处理socket连接。当程序运行后，该类的对象会根据设置与服务器建立连接，并额外开启线程定时发送心跳包，用来使socket保持连接。收到来自服务器端的消息后，通过该类的方法进行处理；客户端需要向服务器发送数据包时，使用该类中的方法通过建立的socket连接进行发送。

    `ChatClient`类继承自 `PyQt`中的 `QMainWindow`界面，包含 `ChatConnection`的实例化对象，用来展示客户端的各种页面组件，以及处理UI交互和与服务器的通信。当收到来自 `ChatConnection`的response类数据包时，通过该类的方法进行处理。

    `MainPage`类，用来构建聊天程序中的主页面，用来在不同页面间进行切换（如：登录，注册，注销）

    `RegisterPage`类，用来构建注册账户的UI界面，用户可以在此注册账号

    `LoginPage`类，用来构建登录UI界面，输入已注册的账号、密码后进入聊天界面

    `DeletePage`类，用来构建删除账号的界面，用来注销已注册的账号，注销后账号无法使用

    `ChatPage`类，聊天程序的主体界面，可以在此UI界面中进行文字聊天、文件发送、添加好友、删除好友、查看好友在线状态等操作。

    `Config`类，打开 `config.ini`文件并从中读取相关配置（如：服务器IP地址，使用的端口号等），从而在更改设置时能够使程序及时调整，增加程序的扩展性。

##### GBN程序

### 3.聊天程序关键代码描述

#### 用户注册、登录、注销及登出

##### 注册

    用户在GUI中输入注册的用户名和密码，点击注册按钮，客户端向服务器端发送注册用户请求。服务器端接收到请求后，通过用户管理模块进行注册用户操作，注册时，会首先验证请求的用户名和密码信息是否是符合一定的规范，比如长度要求等，然后会检查该用户名是否已经存在，若不存在，则在表中新建一条用户名和密码的关系，其中密码使用hash加密存储

##### 登录

    用户在GUI中输入要登录的用户名和密码，点击登录按钮，客户端向服务器端发送登录用户请求。

    服务器端收到请求后，检测用户名及密码是否合法。若合法，则根据用户名在数据库中进行查询，若无法找到相关信息，则提示用户尚未注册，返回信息。若成功查询到用户信息，进一步检测密码与数据库中存储的密码是否匹配。若不匹配，则返回密码错误的消息。

    成功匹配后，服务器端将当前用户放入在线列表，同时向客户端返回登录成功的信息。同时服务器还会检测当前用户的离线消息队列，若队列不为空，则通过`time.sleep(5)`暂停5s后将离线消息发送给用户。无论是一般消息还是文件传输都可以离线传输。

##### 注销

    用户需要注销账号时，点击`Delete Account`按钮，此时客户端向服务器端发送删除账号的数据包。

    服务器在收到数据包后同样通过`_validate_credentials`方法检测账户是否合法。在合法性检测通过后，服务器会把该用户信息从数据库中删除，并返回注销成功的信息。

##### 登出

    在用户结束了聊天或文件传输服务后，点击 聊天界面的`Back`按钮，客户端向服务器端发送 `log_out`数据包。若该用户在online列表中，则将该用户的状态设置为offline，向用户端回复成功登出的信息。

#### 文字聊天

    用户在聊天框中输入聊天消息，点击`Send Message`按钮。若当前未选择任何好友，程序弹窗提示请选择发送消息的好友。

    之后`ChatPage`获取当前页面的 `message_editor`，之后利用 `QTextEditor`的 `toPlainText()`方法获取文本框中的文字。若获取到的文字为空，说明此时用户未输入任何信息，此时不发送数据包，减轻服务器的负载。若当前好友为 `None`，说明不向任何好友发送消息，仅仅展示在消息提示框中。

    成功获取到聊天消息内容和目标好友后，利用`Utils`中的 `MessageBuilder`类构建个人消息数据包，调用 `ChatClient`中的 `send_message`方法将数据包发送给服务器。成功发送数据包后，`ChatPage`将消息展示在 `message_displayer`中，并清空消息编辑框，为下一次发送消息做准备。

    服务器在接收到该类型的数据包后，检测当前目标用户是否在线，若好友在线，则直接将数据包发送给对应的好友；若目标好友不存在，则向离线消息队列中添加该数据包信息，当目标用户上线后，服务器将消息发送给用户。

    客户端在收到来在服务器的消息后，从数据包中提取时间戳、发送人、信息内容，通过`ChatPage`的 `display_message`方法将数据显示在对应好友的 `message_displayer`中，同时将 `QTextEditor`的光标移动的最后，方便用户及时查看最新消息。

#### 文件传输

    当用户需要进行文件传输时，同样要检测是否已经选择了目标好友，若没有选择则进行提示。之后弹出`QFileDialog`用以选择文件，若未选择任何文件，则直接返回，不进行后续操作。

    成功选取文件后，根据目标好友、文件名、文件大小构建文件传输请求包，发送给服务器。之后程序休眠1s，开启新线程传输文件，防止主线程阻塞造成聊天软件卡死。

    在文件传输线程中，根据配置文件启动一个新的socket，与服务器端的socket连接后，依次读取文件并发送。当文件发送完毕后关闭socket，并在`message_displayer`中提示文件已成功发送。

    服务器端在收到文件传输请求包后，检测存储文件的文件夹是否存在，若存在则开启文件接收，将文件存储在服务器上的指定路径，不存在则创建路径。

    文件接收完毕后，检测目标用户状态，若好友在线则立即将文件转发给用户；若好友不在线，则将该文件放入离线队列，当好友上线后转发给目标好友。

#### 添加、删除好友

##### 添加好友

    在聊天软件中我们加入了添加、删除好友的功能。添加好友时，弹出对话框输入好友名，之后封装`add_friend`数据包并发送给服务器。收到服务器添加成功的消息后，`ChatClient`创建新的好友聊天界面，并将新的好友添加至好友列表中。

    服务器在收到`add_friend`数据包后，检测该用户是否存在，若好友不存在则添加失败并返回信息。之后从数据库中进行检索，若检索结果不为空，说明该好友关系已经存在，无需重复添加。之后服务器向请求方和目的方的好友关系中同时添加好友关系，此时添加好友的过程结束。

##### 删除好友

    删除好友时，通过对话框获取想要删除的好友名，若想要删除的好友为当前正在聊天的好友，则弹窗提示无法删除当前好友。删除其他好友时，客户端向服务器端发送`remove_friend`数据包，收到服务器的成功信息后，将该好友的聊天框删除，同时将好友名从好友列表中移除。

    服务器在收到`remove_friend`数据包后，检测是否存在该用户以及好友关系是否存在，若不存在，则返回删除失败的消息。若用户存在、好友关系存在，则将数据库中的双向好友关系删除，返回删除成功的消息。
